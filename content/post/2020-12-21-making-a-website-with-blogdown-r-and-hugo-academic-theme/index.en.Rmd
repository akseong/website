---
title: Making a Website with Blogdown, R, and Hugo Academic Theme
author: Arnie
date: '2020-12-28'
slug: make-website
categories:
  - guide
tags:
  - R
  - blogdown
  - HUGO
subtitle: 'join us on the glorious webtubeways of the blagoblag!'
summary: ''
authors: []
lastmod: '2020-12-21T19:36:17-08:00'
featured: no
image:
  caption: 'https://xkcd.com/181/'
  focal_point: ''
  preview_only: no
projects: []
---

```{r openingchunk, echo=FALSE, eval=TRUE}
knitr::opts_chunk$set(message=FALSE, 
                      eval=FALSE,
                      warning=FALSE,
                      echo=TRUE)

render_toc <- function(
  filename, 
  toc_header_name = "Table of Contents",
  base_level = NULL,
  toc_depth = 3
) {
  # credit Garrick Aden-Buie
  # https://www.garrickadenbuie.com/blog/add-a-generated-table-of-contents-anywhere-in-rmarkdown/
  x <- readLines(filename, warn = FALSE)
  x <- paste(x, collapse = "\n")
  x <- paste0("\n", x, "\n")
  for (i in 5:3) {
    regex_code_fence <- paste0("\n[`]{", i, "}.+?[`]{", i, "}\n")
    x <- gsub(regex_code_fence, "", x)
  }
  x <- strsplit(x, "\n")[[1]]
  x <- x[grepl("^#+", x)]
  x <- x[!grepl("^# \\{", x)]
  if (!is.null(toc_header_name)) 
    x <- x[!grepl(paste0("^#+ ", toc_header_name), x)]
  if (is.null(base_level))
    base_level <- min(sapply(gsub("(#+).+", "\\1", x), nchar))
  start_at_base_level <- FALSE
  x <- sapply(x, function(h) {
    level <- nchar(gsub("(#+).+", "\\1", h)) - base_level
    if (level < 0) {
      stop("Cannot have negative header levels. Problematic header \"", h, '" ',
           "was considered level ", level, ". Please adjust `base_level`.")
    }
    if (level > toc_depth - 1) return("")
    if (!start_at_base_level && level == 0) start_at_base_level <<- TRUE
    if (!start_at_base_level) return("")
    if (grepl("\\{#.+\\}(\\s+)?$", h)) {
      # has special header slug
      header_text <- gsub("#+ (.+)\\s+?\\{.+$", "\\1", h)
      header_slug <- gsub(".+\\{\\s?#([-_.a-zA-Z]+).+", "\\1", h)
    } else {
      header_text <- gsub("#+\\s+?", "", h)
      header_text <- gsub("\\s+?\\{.+\\}\\s*$", "", header_text) # strip { .tabset ... }
      header_text <- gsub("^[^[:alpha:]]*\\s*", "", header_text) # remove up to first alpha char
      header_slug <- paste(strsplit(header_text, " ")[[1]], collapse="-")
      header_slug <- tolower(header_slug)
    }
    if (header_text != ""){
      paste0(strrep(" ", level * 4), "- [", header_text, "](#", header_slug, ")")
    }
  })
  x <- x[x != ""]
  knitr::asis_output(paste(x, collapse = "\n"))
}

# TEXT/TABLE FORMATTING----
colorhtml <- function(x, color="MediumOrchid") {
  sprintf("<span style='color: %s;'>%s</span>", color, x)
}
```



# Why use this guide?

This isn't really a guide I wrote as much as a cobbling-together of guides/info from different sources (mostly by Alison Hill and Yihui Xie) plus my very inexpert observations as a first-time user.  If you want a streamlined guide, [Alison Hill's 2019 slides on starting a website with __blogdown__ and Hugo](https://arm.rbind.io/slides/blogdown.html) are the bees' knees.  

One reason you might still want to use this guide, however: __Academic Theme for Hugo seems to have had some major changes__ in an update earlier this year.  I was not aware of these changes, and enough things went wrong --- __plots didn't show up!  deployment failed due to some odd bug!__--- that made me decide I needed to start over.  I was also following a different guide, not Alison's, for this ill-fated first attempt.  So hopefully my experience as a first-time user of __blogdown__ & Academic Theme & Hugo can help save you some frustration and time.

I'll try to note any deviations, but in general this post borrows _heavily_ from Alison Hill's presentation slides.  It's worth mentioning that my appreciation for the team at RStudio --- already considerable --- grew remarkably after fumbling my way through all of this and stumbling on their wonderfully open and welcoming approach to creating and documenting tools.  



## Who is this meant for?

Essentially, people like me a week ago: though I use R, __rmarkdown__, and GitHub daily, I had roughly, oh, about exactly zero experience with HTML, Hugo, or the __blogdown__ package. 

You might also find this helpful if you are troubleshooting your Academic Theme website after updating it recently.

Also worth mentioning: I'm on a PC, so things might be a bit different for you Mac folks out there.



## Caveats

I'm not anywhere near an expert on any of this!  A lot of this (ok all of it) is cobbled together from different sources --- I'm basically just an expert on Googling.  So some of the workarounds here may be sub-optimal / not necessary anymore / just not necessary.  Please feel free to let me know!






# Table of Contents:

```{r echo=FALSE, eval=TRUE}
render_toc(filename="index.en.Rmd")
# render_toc(filename)
```



# Preliminaries:

## Note on changes to Academic Theme

As mentioned earlier, Academic Theme for Hugo had an update earlier this year: it became part of something called Wowchemy, and this appears to have broken a few things for some people, or required different settings, probably because

  1. its folder structure changed, and 
  1. how it, um, handles some stuff is like, different.  (I really have no idea)

A major thing that did not work for me was that __plots from .Rmd code chunks__ were not displayed, even though [this should work out-of-the-box](https://bookdown.org/yihui/blogdown/dep-path.html), I suspect because the folder structure changed.  Though it could just have been user error or some outdated settings.  Or the fact that my computer is mostly duct tape, [pasta](https://en.wikipedia.org/wiki/Alien_(film)#:~:text=pasta), and a hamster wheel.  




## Resources  

(ordered from most used to least used)

1. [slides by Alison Hill](https://arm.rbind.io/slides/blogdown.html)
    - These are for a different theme, but her advice is accurate, practical, and clear.  Plus it's easy to follow steps in this presentation format.

1. [__blogdown__ documentation by Yihui Xie](https://bookdown.org/yihui/blogdown/hugo.html)
    - Yihui Xie is basically the Gandalf of the Fellowship of R Users.  

1. [Wowchemy customization guide](https://wowchemy.com/docs/customization/)
    - It was hard as a first-time user to find the info I needed here, but if/once I did, it was helpful.

1. [post by Matteo Courthoud](https://matteocourthoud.github.io/post/website/) on making a website
    - This is the guide I started off using first, leading to a rebuild.  As such, I don't recommend using this --- some of the specifics seem to be outdated.  __Follow Alison Hill's guide instead__.  I _did_, however, find it helpful to have already read Matteo's guide as I started my second attempt.  For example, the [section on Basic Customization](https://matteocourthoud.github.io/post/website/#:~:text=Basic%20Customization) is helpful and specific.  Also, his color scheme is awesome and I totally copied it!





# Starting up:

* This section is almost all from [Alison Hill's slides](https://arm.rbind.io/slides/blogdown.html).

## prep 

+ Install the latest versions of __blogdown__ and Hugo:

```{r}
if (!requireNamespace("devtools")) install.packages('devtools')
devtools::install_github('rstudio/blogdown')
blogdown::install_hugo()
```


+ make a repo on GitHub.
+ create a new Rproject and connect it to the repo. 
  - in Rstudio: File --> New Project --> Version Control --> Git (if you don't know how to do these things, follow [the links in Alison's slides](https://arm.rbind.io/slides/blogdown.html#9).)



:::fyi
If you plan to host your website from GitHub, you will probably want to host it from a repository with the name `<yourGitHubusername>.github.io`.  So you can't use that for this step.
:::






## initialize site with Academic Theme

```{r}
library(blogdown)
new_site(theme="gcushen/hugo-academic",
         sample=TRUE,
         theme_example=TRUE,
         empty_dirs = TRUE,
         to_yaml = TRUE)
```

After that finishes, see if the site builds locally.  Use the "Addins" dropdown (end of the 2nd row of Rstudio's menu bar) to select "Serve site" or use

```{r}
blogdown::serve_site()
```


## .gitignore

Before we move on, add the `resources` and `public` folders to your `.gitignore` file so that it looks like this:
```{r}
.Rproj.user
.Rhistory
.RData
.Ruserdata
public/
resources/

```

:::fyi
If you haven't done this already, make sure your RStudio is configured to [make source files end with a newline](https://yihui.org/en/2018/04/rprofile-trailing-newline/).  

tl/dr; when you need it, not having it breaks things, and when you don't need it, having it doesn't harm anything.  It's kind of like [Pascal's Wager](https://en.wikipedia.org/wiki/Pascal%27s_wager), just a smidge less consequential.
:::




## check deployment 

Don't skip this step!  It will help you detect problems as you move forward.  I skipped it the first time through --- no one said why to do it, and I didn't see the point of deploying so early on --- and ended up starting over.

Two common options for hosting:

+ __Netlify via GitHub__: best if you want a different domain name, auto-deployment, or a web-form for messages.

+ __GitHub__: simpler on the face of it, but a few more steps required for deployment every time you update.





### option 1: netlify deployment (recommended)

:::fyi
Alison Hill recommends building the site locally, then dragging/dropping the `public` folder into Netlify.  This is too many steps for me to follow each time I want to see what the website looks like, and doesn't let me take advantage of netlify's deploy branches option to test changes I make to the website before putting them out into the world.  So I'm going to walk you through setting up continuous deployment from a Github repo.
:::



__Steps:__  

  1. Push everything to your GitHub repo. Don't use the Git tab!  Checking those boxes will take a loooong time if it completes at all.  Instead (will still take a minute, but it's _much_ faster), in the RStudio terminal (the tab next to your console), type:
  ```
  git add -A               # stages everything
  git commit -m "init"     # commit with message "init"
  git push  
  ```

  2. While you're waiting, set up an account at [netlify.com](netlify.com).
  1. Once you have an account and everything has been pushed, click "New site from Git" --> Github --> Only select repositories --> select your website repo.
      + If you end up using a different repo for some reason, you can always give Netlify access to another repo using the "Configure the Netlify app on Github" link at the bottom of the page.
  1. Your url will be something weird like "youthful-piranha-4ec83f".  
      + Change it: "Site settings" link --> "Change site name" link.

You can always change the site name, or redirect the build to a new domain.  [`rbind.io` is a nice, free option](https://support.rbind.io/about/).

Cool!  Now whenever you push to your repo, netlify will build it and serve your website.

Also, to use the branch deploy feature, all you have to do now is create a branch __and pull it__, and netlify will let you preview it!  [More details + suggested workflow here](https://www.garrickadenbuie.com/blog/blogdown-netlify-new-post-workflow/).
  




### option 2: Github deployment

__Steps:__  

1. Build the site: "Build" tab (next to Environment, History, Connections) --> Build Website
    + This builds your website locally, in a new folder named `public` in your project root directory.
1. Get the contents of the `public` folder (not the folder itself, just what's inside) into a GitHub repo named `<yourGitHubusername.github.io>`.  For example, my repo would be named `akseong.github.io`, and that would also be the url of my website.  

__Done!__  Super easy, but unfortunately, whenever you want to update your website or add content, you will need to follow these same steps.





# Folder structure

Alison Hill gives you [a short assignment](https://arm.rbind.io/slides/blogdown.html#24) to figure out your folder structure, and I think it's helpful to go through.  Your folders / files are going to look a little different, though (updates since 2019, different theme).

_Your_ folder structure will look like this (unless it's changed yet again!):

```{r}
├───archetypes
├───assets            # CSS, icons
├───config            
│   └───_default      # site customizations
├───content           
│   ├───authors       # modify about page info in the 'admin' folder
│   ├───courses
│   ├───home          # splash page
│   ├───post
│   ├───project
│   ├───publication
│   ├───slides
│   └───talk
├───data              
│   ├───fonts         
│   ├───themes        # "themes" = color scheme
├───layouts           # overrides theme layouts
├───R
├───resources         # intermediary build files - delete often
├───static            # place for files that do not need to get "built" by Hugo
│   ├───admin
│   └───media         # images used with posts/projects
└───themes            # NO TOUCH!  
```


The comments should be fairly self-explanatory, but the `content` folder is worth discussing a little here.  The general idea is that the existing folders inside the `content` folder either  

1. are a separate page in the website
    - these folders contain an `index.md` file + widget `.md` files
1. contain info used by widgets  
    - these folders usually contain a subfolder for each piece of content, e.g. each post or project

This is a little loose (e.g. the `contents/home/gallery` folder doesn't fit so neatly in here) but I find it useful to think of it this way.

The `home` folder is the only "separate page"-type folder here right now --- the Academic Theme by default generates a 1-page website --- but you can [add new folders for new website pages](#separate-pages).  Inside `content/home`, you'll see a file `index.md` which indicates that this is a "widget page".  The other `.md` files inside the folder activate different widgets on the home page.

Folders containing info used by widgets will have a file `_index.md` (note the underscore) and subfolders for each entry.  For example, the folder `content/post/` is where your blog posts go by default, and each post gets its own subfolder inside `content/post`.  The widget that uses the content in `content/post` is actually `contents/home/posts.md`, which contains the lines 

``` 
widget: pages              # <-- widget type
...<other options>... 
page_type: post            # <-- where to find the content for the widget
```
These lines indicate that this is a `pages`-type widget, with content in the folder named `post`.  This file, `posts.md` is in `contents/home/` since by default the widget is displayed on the home page.





# Basic customization

Now to make your website yours!  A few tips for troubleshooting while editing your website:

1. If not already running, use `blogdown::serve_site()` to see how your website responds to changes you make.  (You can also open the site in a browser tab using the "show in new window" icon in the viewer pane menu bar)
1. If changes you make do not seem to be appearing, stop and restart the local server by running `blogdown::stop_server()`, then `blogdown::serve_site()`.
1. If that doesn't work, try stopping the local server, deleting the `resources/` and `public/` folders in your project's root directory, and then starting the local server again.  

:::fyi
+ `resources/` contains intermediary build files, and will be auto-generated as needed.
+ `public/` is generated when you build the website using the "Build" tab.  If you opted for continuous deployment via Netlify, you don't need to build the website locally.
:::

4. Otherwise, take a look at [Alison Hill's troubleshooting guide](https://alison.rbind.io/post/2019-03-04-hugo-troubleshooting/), the [resources](#resources) linked above, other peoples' website repos ([here's mine](https://github.com/akseong/website)), or just Google it!




## Site config

There are 4 main files to edit:  

+ `config.yaml`: general site configuration (next section).
+ `config/_default/params.toml`: personal info + site feature configuration, e.g. syntax highlighting.  File is heavily commented, and does a fairly good job of explaining different options.
+ `config/_default/menus.toml`: navbar configuration.  Fairly straightforward (less straightforward if you want [separate pages instead of one long scrolling page](#separate-pages)).

If in doubt about a particular setting in `params.toml` or `menus.toml`, leave it for now. However, `config.yaml` requires a bit more care.



### config.yaml
In `config.yaml` in your root directory, change the following fields:  

  + `title:` site name (your name if this is a personal website)
  + `baseurl:` set it to the url (in quotes) your site has been deployed to.  You didn't skip that step, did you?  If you did, you can also change it to '/'.  But it must be specified.  
      - include "https://" in the url.  Also, see [Yihui Xie's post on redirecting HTTP to HTTPS](https://yihui.org/en/2017/11/301-redirect/#an-application-redirect-http-links-to-to-https)
  + `ignoreFiles:` Yihui Xie [recommends specifying these regex patterns](https://bookdown.org/yihui/blogdown/configuration.html#:~:text=at%20least%20these%20patterns).  If you've been following this guide so far, you have a `config.yaml` file instead of a `config.toml` file (as in the link).  The only things you should need to add to the default list under `ignoreFiles` are 
  
```{r}
    - \.knit\.md$
    - \.utf8\.md$
```


:::fyi
Some guides recommend including `"_files$"` in `ignoreFiles`, `r colorhtml("but this will break plots in .Rmd-generated posts")`.  

[Alison Hill's slides](https://arm.rbind.io/slides/blogdown.html#29) recommend including it, so I'm assuming it's fine to include it if you're working with the Ada theme and/or deploying via drag/drop as her guide recommends --- in other words, if you're actually following her guide!
:::


Add the lines (I put these right beneath `baseurl:`):
```{r}
relativeURLs: yes
canonifyURLs: yes
```

+ `relativeURLs: yes` is necessary for cloud setup.  Also, if you don't specify your `baseurl`, some external links will break (spent an hour until I figured this out when trying to make a link to github in my nav bar --- worked in my local build, but not when deployed).

+ `cannonifyURLs: yes`: my understanding is that this makes it so that other people sharing your content via social media will link back to your actual website.

Last, beneath `permalinks`, I suggest adding `post: /:year-:month-:day/:slug/` (follow indents; modifies post urls, e.g. ".../2020-12-28/make-website/" rather than ".../post/make-website/").





## Your info

:::fyi
For ease of editing, bring the `about.md` widget to the top of the page by deactivating the `hero.md` and `demo.md` widgets in `content/home/` (set `active: false`), or make these widgets come after the `about.md` widget (set `weight:` > 20).  It will just be easier to see (using `blogdown::serve_site()`) the changes you're making.  You can always reactivate/reorder these widgets later.
:::

The `about.md` widget in `content/home/` uses info from the folder `content/authors/admin/`.  

+ For the text, edit `_index.md` with your info.  _Quick note:_ the `bio:` field in the header is what appears next to your name at the end of posts, not in the section generated by the "about" widget.
+ Add your picture by placing a .jpg image into `content/authors/admin/` and naming it `avatar.jpg`



## Other widgets

Poke around `content/home/` and modify the content of the different widgets with your info.

+ deactivate the widgets you don't want by setting `active: false`.  In general I would not delete these, as they are useful templates.
+ modify the order in which widgets appear using the `weight:` parameter (lower numbers = higher on page)







# Troubleshooting / adding desired functionality

## Modification to fix plotting

As mentioned waaaay earlier, plots generated by code chunks in .Rmd files were not showing up on my website.  This fixed it for me:  

1. create a setting in your `.Rprofile` to initialize new blog posts with a [page bundle](https://alison.rbind.io/post/2019-02-21-hugo-page-bundles/#hugo-page-bundles).

```{r}
library(usethis)
edit_r_profile()
options(blogdown.new_bundle = TRUE)
```

2. in `config.yaml` (root folder; these should already be OK if you've followed this guide)
  + `relativeURLs: yes`
  + `_files$` __`r colorhtml("MUST NOT BE")`__  under `ignoreFiles:`

My guess is that using page bundles and relative urls ensure that the built html page refers to the `*_files/` folder to source the images.  Again, this _was_ my first rodeo with blogdown and Hugo, so I do not know whether all of these steps are necessary --- I just know that plots weren't working before I changed these things, and then started showing up after I did these things.  It is entirely possible that only some of these things were necessary, but all of these things are recommended in the slides by Allison Hill anyways, _except_ for taking out `_files$` from `ignoreFiles:`.



## Add anchor link icons to post headings

+ [this worked for me](https://ericbryantphd.com/2020/01/13/add-section-links-in-blogdown/#my-solution)

+ [this looks intriguing](https://github.com/rstudio/hugo-graphite/issues/38), but I couldn't figure out exactly what was happening.

+ [while writing this post, I found this solution by Gandalf, erm Yihui Xie](https://yihui.org/en/2018/11/md-js-tricks/#how-to-add-anchor-links-to-section-headings).  I just tried this, but there must be some steps left out that would be obvious to someone who uses javascript/blogdown/html/Hugo a lot, which is not me.


## ToC placement

Generating a table of contents using the built-in shortcodes or .Rmd header puts the table of contents first.  This is usually a good thing, except it can take up your entire post preview (i.e. the text you see below the post titles [here](/post_landing/){target="_blank"}.  

[Here's a workaround from Garrick Aden-Buie](https://www.garrickadenbuie.com/blog/add-a-generated-table-of-contents-anywhere-in-rmarkdown/) so that you can place the table of contents anywhere you'd like.




















# Customization: advanced

## Themes / Fonts

## separate pages
`config/_default/menus.toml`
If you would like your website to be split across multiple separate pages (as opposed to one long scrolling page), 

- new pages instead of just one long scrolling page
index.md

```
widget: pages              # <-- widget type
...<other options>...
page_type: post            # <-- where to find the content for the widget
```

## widget backgrounds
look at widgets that have backgrounds already (e.g. `contents/home/demo.md`), copy stuff. 
+ static









# general notes

- wowchemy file structure
- deleting examples
- .rmd support



